<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registrar o Editar Plancha</title>
</head>
<body>
  <h2 id="tituloFormulario">Registrar Plancha</h2>

  <form id="formularioPlancha" enctype="multipart/form-data" method="POST">
    <input type="hidden" name="id" id="idEditar"> <!-- oculto para edición -->

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Pregunta:</label><br>
    <select name="pregunta" id="pregunta" required></select><br><br>

    <label>Tipo de Solicitud:</label><br>
    <select name="tipo" id="tipo" required></select><br><br>

    <label>Agrupador:</label><br>
    <input type="text" name="agrupador" required><br><br>

    <label>Imagen:</label><br>
    <input type="file" name="imagen" accept="image/*"><br><br>

    <label>O URL:</label><br>
    <input type="text" name="url"><br><br>

    <button type="submit" id="btnGuardar">Guardar Plancha</button>
  </form>

  <h3>Planchas registradas</h3>
  <div id="listaPlanchas"></div>

<script>
let modoEditar = false;
let idEditar = null;

// Cargar preguntas
fetch('ajax/planchasAjax.php?action=preguntas')
  .then(res => res.json())
  .then(data => {
    const select = document.getElementById("pregunta");
    data.forEach(p => {
      const option = document.createElement("option");
      option.value = p.ID_PREGUNTA;
      option.textContent = p.PREGUNTA;
      select.appendChild(option);
    });
  });

// Cargar tipos de solicitud
fetch('ajax/planchasAjax.php?action=tipos')
  .then(res => res.json())
  .then(data => {
    const select = document.getElementById("tipo");
    data.forEach(t => {
      const option = document.createElement("option");
      option.value = t.ID_TIPO_SOLICITUD;
      option.textContent = t.TIPO_SOLICITUD + " (" + t.AGRUPADOR + ")";
      select.appendChild(option);
    });
  });

// Mostrar planchas
function cargarPlanchas() {
  fetch('ajax/planchasAjax.php?action=listar')
    .then(res => res.json())
    .then(data => {
      const contenedor = document.getElementById("listaPlanchas");
      contenedor.innerHTML = "";
      data.forEach(p => {
        const div = document.createElement("div");
        div.innerHTML = `
          <strong>${p.OPCION}</strong> - <a href="${p.URL}" target="_blank">Ver imagen</a>
          <button onclick="editarPlancha(${p.ID_OPCION_PREGUNTA})">Editar</button>
          <button onclick="eliminarPlancha(${p.ID_OPCION_PREGUNTA})">Eliminar</button>
        `;
        contenedor.appendChild(div);
      });
    });
}

// Editar
function editarPlancha(id) {
  fetch(`ajax/planchasAjax.php?action=obtener&id=${id}`)
    .then(res => res.json())
    .then(data => {
      if (data && data.ID_OPCION_PREGUNTA) {
        modoEditar = true;
        idEditar = data.ID_OPCION_PREGUNTA;
        document.getElementById("idEditar").value = idEditar;
        document.querySelector('input[name="nombre"]').value = data.OPCION;
        document.querySelector('input[name="url"]').value = data.URL || "";
        document.getElementById("tituloFormulario").textContent = "Editar Plancha";
        document.getElementById("btnGuardar").textContent = "Actualizar Plancha";
      } else {
        alert("No se pudo obtener la información de la plancha");
      }
    });
}

// Eliminar
function eliminarPlancha(id) {
  if (!confirm("¿Estás seguro de eliminar esta plancha?")) return;

  fetch(`ajax/planchasAjax.php?action=eliminar&id=${id}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        alert("Plancha eliminada");
        cargarPlanchas();
      } else {
        alert("Error al eliminar: " + (data.mensaje || "Desconocido"));
      }
    });
}

// Enviar formulario
document.getElementById("formularioPlancha").addEventListener("submit", function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const action = modoEditar ? "actualizar" : "registrar";

  fetch(`ajax/planchasAjax.php?action=${action}`, {
    method: "POST",
    body: formData
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        alert(modoEditar ? "Plancha actualizada" : "Plancha registrada");
        this.reset();
        modoEditar = false;
        idEditar = null;
        document.getElementById("tituloFormulario").textContent = "Registrar Plancha";
        document.getElementById("btnGuardar").textContent = "Guardar Plancha";
        cargarPlanchas();
      } else {
        alert("Error: " + (data.mensaje || "Error desconocido"));
      }
    });
});

cargarPlanchas(); // inicial
</script>

</body>
</html>
